pipeline {
    agent any
    
    tools {
        nodejs "nodejs"
    }

    environment {
      ECR_REPO = 'node-app'
      IMAGE_TAG = 'latest'
    }

    stages {
        stage('Checkout') {
            steps {
                checkout([$class: 'GitSCM', branches: [[name: '*/Do-06-Hang']], userRemoteConfigs: [[url: 'https://github.com/hangzh521/FotoPie-Front-end.git']]])
            }
        }

        stage('SonarQube Scan') {
            environment {
                sonarqube_token = credentials('sonarqube_token')
                sornarqube_url = credentials('sornarqube_url')
                }
            steps {
             script {
               def scannerHome = tool 'SonarScanner'
               withSonarQubeEnv('SonarQube Server') {
                sh "${scannerHome}/bin/sonar-scanner \
                      -Dsonar.projectKey=fotopie-front-end \
                      -Dsonar.sources=. \
                      -Dsonar.host.url=$sornarqube_url \
                      -Dsonar.login=$sonarqube_token"
                  }
               }
            }
         }

        stage("Quality Gate") {
            steps {
              timeout(time: 2, unit: 'MINUTES') {
                waitForQualityGate abortPipeline: true
            }
          }
        }

        stage('Build Docker Image') {
            environment {
                BACKEND_API = credentials('BACKEND_API')
                Get_Synonyms_API_Prefix = credentials('Get_Synonyms_API_Prefix')
            }
        
            steps {
              sh 'docker build --build-arg BACKEND_API=$BACKEND_API --build-arg Get_Synonyms_API_Prefix=$Get_Synonyms_API_Prefix -t $ECR_REPO:$IMAGE_TAG .'
            }
        }
        
        stage('Push Docker Image to ECR') {
            environment {
                AWS_ACCESS_KEY_ID = credentials('AWS_ACCESS_KEY_ID')
                AWS_SECRET_ACCESS_KEY = credentials('AWS_SECRET_ACCESS_KEY')
                AWS_DEFAULT_REGION = credentials('AWS_DEFAULT_REGION')
                ECR_REGISTRY = credentials('ECR_REGISTRY')
              }
           steps {
                    sh 'aws ecr get-login-password --region $AWS_DEFAULT_REGION | docker login --username AWS --password-stdin $ECR_REGISTRY'
                    sh 'docker tag $ECR_REPO:$IMAGE_TAG $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG'
                    sh 'docker push $ECR_REGISTRY/$ECR_REPO:$IMAGE_TAG'
              }
           }
       }
    }
 



 